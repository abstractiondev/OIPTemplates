<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AGI | Welcome</title>
    <link rel="stylesheet" href="../assets/css/foundation.css" />
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" type="text/css" media="all" href="../assets/css/whhg.css" />
    <script src="../assets/js/modernizr.js"></script>
</head>
<body>

<!-- FIRST ATTEMPT TO THE TOP BAR
<div class="contain-to-grid sticky">
    <nav class="top-bar" data-topbar>
    <div class="row">
        <div class="large-4 columns">
            <ul class="title-area">
                <li class="name">
                    <h1><a href="#">Logo Goes Here</a></h1>
                </li>
                <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
            </ul>
        </div>
        <div class="large-4 columns"></div>
        <div class="large-4 columns">
            <section class="top-bar-section">
            &lt;!&ndash; Right Nav Section &ndash;&gt;
            <ul class="right">
                <li><a href="http://www.aalto.fi" target="_blank">Aalto.fi</a></li>
                <li class="has-dropdown">
                    <a href="#">Schools</a>
                    <ul class="dropdown">
                        <li><a href="#">School of arts, design and architecture</a></li>
                    </ul>
                </li>
            </ul>
                &lt;!&ndash; Left Nav Section &ndash;&gt;
                <ul class="left">
                    &lt;!&ndash;<li><a href="#">Something</a></li>&ndash;&gt;
                </ul>
            </section>
        </div>
    </div>
    </nav>
</div>
-->

<div class="aaltoStickyBar contain-to-grid sticky">
        <div class="row vAlignMiddle">
            <div class="large-3 columns vAlignMiddle"><a href="#" id="stickyBarLogo"><div id="logo"><img src="../assets/images/logo.png"></div></a></div>
            <div class="large-6 columns">
                <div class="portfolioFilter" id="portfolioFilterDivContainer">
                </div>
            </div>
            <div class="large-3 columns">
                <ul class="inline-list right" style="line-height: 45px;padding:0;margin:0;">
                    <li><a href="http://www.aalto.fi" target="_blank" class="small"><span class="discreetLinks">Aalto.fi</span></a></li>
                    <li><a href="#" class="small"><span class="discreetLinks">Schools</span></a></li>
                </ul>
            </div>
        </div>
</div>
<div class="row" style="height: 45px;"></div>
<div class="row" id="isotope_content_row">

    <div id="ModalsHolderDiv-Content">
        <div id="viewContentModal" class="reveal-modal" data-reveal>
        </div> <!--closes div for the viewContentModal-->
    </div>
    <!-- +++Isotope content starts +++++++++++++++++++++++++++++++++++++++++++++ -->
    <div class="large-12 columns issuuContentContainer" style="padding: 0 !important;">
        <div id="contentDivContainer" class="contentDivContainerIsotope"></div>
    </div>
    <!-- +++Isotope content ends +++++++++++++++++++++++++++++++++++++++++++++ -->
</div>


<script src="../assets/js/jquery.js"></script>
<script src="../assets/js/foundation.min.js"></script>
<!--<script src="js/foundation/foundation.js"></script>-->
<script src="../assets/js/foundation/foundation.topbar.js"></script>
<script src="../assets/js/jquery.isotope.js" type="text/javascript"></script>
<script src="../assets/js/jquery.form.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/dustjs-linkedin/2.0.0/dust-core.min.js"></script>
<script src="maincategories_dust.js"></script>
<script src="contentcards_dust.js"></script>
<script src="viewcontent_dust.js"></script>

<!-- MarkdownDeep Rendering -->
<link rel="stylesheet" href="../assets/lib/markdowndeep/mdd_styles.css">
<script type="text/javascript" src="../assets/lib/markdowndeep/MarkdownDeepLib.min.js"></script>


<script>
    $(document).foundation(
            {
                reveal : {
                    animation: 'fadeAndPop',
                    animation_speed: 250,
                    close_on_background_click: false
                }

            }
    );
</script>
<script>
    var isotopeInitialization = function() {

    };
    $(document).ready(function(){
        $.ajaxSetup({cache: false});

        getAndPopulate_Isotope_Filter_Categories();
        /*
        $.when(get_content()).then(function(){
        }).fail(function(){console.log( "something went wrong with getting the content" );});
        */
        get_content();
        $("#contentDivContainer").on('mouseover',reLayout_isotope);
        /*
        $("#contentDivContainer").delegate(".cardClickableWrapper",{ click: viewContent } );
        */

        var bindView = function () {
            $(".cardClickableWrapper").click(function (editEvent) {
                var itemUrl = $(this).data("itemurl");
                var textContentUrl = itemUrl;
                $.ajax({ url: textContentUrl, cache: false,
                    success: function (textContentData) {
                        if(textContentData.RawHtmlContent) {
                            textContentData.ExcerptRendered = textContentData.Excerpt;
                            textContentData.BodyRendered = textContentData.Body;
                        } else {
                            markdown = new MarkdownDeep.Markdown();
                            markdown.SafeMode = true;
                            var excerptRendered = markdown.Transform(textContentData.Excerpt.replaceAll("javascript:", ""));
                            textContentData.ExcerptRendered = excerptRendered;
                            var bodyRendered = markdown.Transform(textContentData.Body.replaceAll("javascript:", ""));
                            textContentData.BodyRendered = bodyRendered;
                        }

                        var content = getCardContentFromTextContent(textContentData, "256");
                        dust.render("viewcontent.dust", content, function (err, out) {
                            $("#viewContentModal").html(out);
                            $("#closeViewContentModal").click(function () { $('#viewContentModal').foundation('reveal', 'close');});
                            $('#viewContentModal').foundation('reveal', 'open');
                        });
                    }
                }) //ends getJson
            });//-------ends: triggers the event if the "VIEW" button in the content card is pressed... on ANY of them
        }


        function getAndPopulate_Isotope_Filter_Categories ()
        {
            //var goMessage="One headlight";
            //$("#testPanelGo").append(goMessage);
            console.log("Entered 'getAndPopulate_Isotope_Filter_Categories' Function.");
/*
            var multihandlerResponse = $.ajax({
                url: "rootcategories.json",
                //type: "POST",
                //data: ({action: 'getMainCategories'}),
                async: true,
                success: function(responseContent) {
                    dust.render("maincategories.dust", responseContent, function (err, out) {
                        $("#portfolioFilterDivContainer").html(out);
                    });
                }
            });
*/
        }

        var getCategoriesOrderedAndFiltered = function(categoryCollection)
        {
            var categories = categoryCollection.CollectionContent;
            var orderFilterIDList = categoryCollection.OrderFilterIDList;
            var orderedCategories = [];
            for(i = 0; i < orderFilterIDList.length; i++)
            {
                var currID = orderFilterIDList[i];
                var result = $.grep(categories, function(candidate) { return candidate.ID == currID });
                if(result.length == 0)
                    continue;
                var cat = result[0];
                orderedCategories.push(cat);
            }
            return orderedCategories;
        };

        var getRootCategories = function(categoryCollection)
        {
            var orderedCategories = getCategoriesOrderedAndFiltered(categoryCollection);
            var rootCategories = $.grep(orderedCategories, function(candidate) { return !candidate.ParentCategoryID; });
            return rootCategories;
        };

        var getCategoriesBasedByNamesOrIDs = function(categoryCollection, nameShortTextCollection, categoryIDList)
        {
            var orderedCategories = getCategoriesOrderedAndFiltered(categoryCollection);
            var filteredCategories;
            if(categoryIDList)
            {
                var categoryIDArray = categoryIDList.split(",");
                filteredCategories = $.grep(orderedCategories,
                        function(candidate) {
                            var foundList = $.grep(categoryIDArray, function(idCandidate) {
                                return idCandidate === candidate.ID;
                            });
                            return foundList.length > 0;
                        });
            } else {
                filteredCategories = $.grep(orderedCategories,
                        function(candidate) {
                            var foundList = $.grep(nameShortTextCollection.CollectionContent, function(nameCandidate) {
                                return nameCandidate.Content == candidate.CategoryName;
                            });
                            return foundList.length > 0;
                        });
            }
            return filteredCategories;
        };


        var getCardContentFromNode = function (item, imageSizeString) {
            var authors = item.Authors;
            var authorText = "";
            if(authors) {
                var authorNames = $.map(authors.CollectionContent, function(authorContent) {
                    return authorContent.Content;
                });
                authorText = authorNames.join(", ");
            }
            var categories = item.Categories;
            var imageUrl = item.ImageBaseUrl
                    ? item.ImageBaseUrl + "_" + imageSizeString + "x" + imageSizeString + "_crop" + item.ImageExt
                    : null;
            return { "id": item.ID, "title": item.Title, "excerpt": item.ExcerptRendered,
                "article_text": item.BodyRendered,
                "image": imageUrl,
                "itemUrl": "../" + item.ActualContentUrl + ".json",
                "author": authorText,
                "categories": categories
            };
        };

        var getCardContentFromTextContent = function (item, imageSizeString) {
            var imageUrl = item.ImageData
                    ? "../../AaltoGlobalImpact.OIP/MediaContent/" + item.ImageData.ID + "_" + imageSizeString + "x" + imageSizeString + "_crop" + item.ImageData.AdditionalFormatFileExt
                    : null;
            return { "id": item.ID, "title": item.Title, "excerpt": item.ExcerptRendered,
                "article_text": item.BodyRendered,
                "image": imageUrl,
                "itemUrl": "../../AaltoGlobalImpact.OIP/TextContent/" + item.ID + ".json"
            };
        };

        String.prototype.replaceAll = function(strReplace, strWith) {
            var reg = new RegExp(strReplace, 'ig');
            return this.replace(reg, strWith);
        };

        function get_content(){
            $("#contentDivContainer").empty();
            return $.getJSON('../../AaltoGlobalImpact.OIP/NodeSummaryContainer/default.json', function(nodeSummaryContainer) {

                nodeSummaryContainer.RootCategories = getRootCategories(nodeSummaryContainer.NodeSourceCategories);
                for(var nodeIX = 0; nodeIX < nodeSummaryContainer.Nodes.CollectionContent.length; nodeIX++)
                {
                    var nodeObj = nodeSummaryContainer.Nodes.CollectionContent[nodeIX];
                    nodeObj.Categories = getCategoriesBasedByNamesOrIDs(nodeSummaryContainer.NodeSourceCategories, nodeObj.CategoryNames, nodeObj.CategoryIDList);
                }


                var content = nodeSummaryContainer;
                markdown = new MarkdownDeep.Markdown();
                markdown.SafeMode = true;
                var contentData =
                {
                    "content": $.map(content.Nodes.CollectionContent, function (item) {
                        var rendered = markdown.Transform(item.Excerpt.replaceAll("javascript:", ""));
                        item.ExcerptRendered = rendered;
                        return getCardContentFromNode(item, "64");
                    })
                };
                dust.render("maincategories.dust", nodeSummaryContainer, function (err, out) {
                    $("#portfolioFilterDivContainer").html(out);
                });
                dust.render("contentcards.dust", contentData, function (err, out) {
                    $("#contentDivContainer").html(out);
                    bindView();
                    start_isotope();
                    console.log( "Isotope fired after getting content, succeed" );
                });
/*
                for (var i in contentData.content) {
                    //noinspection JSUnfilteredForInLoop

                    user_content+="<div class='content-card "+contentData.content[i].content_type+"' id='contentCardDataId-"+contentData.content[i].id+"'>";

                    user_content+="<a href='#' class='cardClickableWrapper'>";


                    user_content+="<img src='../assets/"+contentData.content[i].image+"' alt='image' id='contentCardImage-dataID-"+contentData.content[i].id+"'/>";
                    user_content+="<div class='content-card-fancyTag'><span class='fancyTag'>"+contentData.content[i].content_type+"</span></div>";
                    user_content+="<div class='content-card-title' style='font-size:95%; font-weight:bold; color:#000000;' id='contentCardTitle-dataID-"+contentData.content[i].id+"'>"+contentData.content[i].title+"</div>";
                    user_content+="<div class='content-card-excerpt' id='contentCardExcerpt-dataID-"+contentData.content[i].id+"'><span class='content-card-spanExcerpt'>"+contentData.content[i].excerpt+"</span></div>";
                    user_content+="<div class='content-card-line'><hr></div>";
                    user_content+="<div class='content-card-excerpt' id='contentCardAuthor-dataID-"+contentData.content[i].id+"'><i class='icon-pencil content-card-spanAuthor'></i>&nbsp;<span class='content-card-spanAuthor'>"+contentData.content[i].author+"</span></div>";
                        var regExp = /\(([^)]+)\)/;
                        var recordedJsonDate = contentData.content[i].Published;
                        var extractedDate = regExp.exec(recordedJsonDate);
                        var cardDate = extractedDate[1].replace(/\+0000/g, '');
                        extractedDate= new Date(1000*cardDate);
                        //cardDate = extractedDate.toLocaleString();
                        cardDate = extractedDate.getDate()+".";
                        cardDate+= extractedDate.getMonth()+".";
                        cardDate+= extractedDate.getFullYear();

                    user_content+="<div class='content-card-excerpt' id='contentCardDate-dataID-"+contentData.content[i].id+"'><i class='icon-calendaralt-cronjobs content-card-spanAuthor'></i></i>&nbsp;<span class='content-card-spanAuthor'>"+cardDate+"</span></div>";

                    user_content+="</a>";

                    user_content+="</div>";


                }//ends for loop
                $("#contentDivContainer").append(user_content);
 */
            })
        }

        function start_isotope(){
            //var $container = $('.portfolioContainer');
            var $container = $("#contentDivContainer");
            $container.isotope({
                filter: '*',
                animationOptions: {
                    duration: 750,
                    easing: 'linear',
                    queue: false
                }
            });

            $('.portfolioFilter a').click(function(){
                console.log ("Entered the Isotope Filter click event handler.")
                $('.portfolioFilter .current').removeClass('current');
                $(this).addClass('current');

                var selector = $(this).attr('data-filter');
                $container.isotope({
                    filter: selector,
                    animationOptions: {
                        duration: 750,
                        easing: 'linear',
                        queue: false
                    }
                });
                return false;
            });
        }//closes function Start_isotope

        function reLayout_isotope() {
            var $container = $('#contentDivContainer');
            $container.isotope( 'reLayout');
        }

        function viewContentOLDNOTUSED(editEvent) {
            console.log ("Entered 'viewContent' function. Triggered ID: "+editEvent.target.id);
            editEvent.preventDefault();
            var currentId=editEvent.target.id;
            var currentId2 = $('#'+currentId).parents(".content-card").attr('id');
            //var clickedEditID= editEvent.target.id.replace("contentCardDataId-", '');
            var clickedEditID= currentId2.replace("contentCardDataId-", '');
            //alert (currentId2);
            $.getJSON('../assets/json/site_settings.json', function(contentData) {
                var queryValue="";
                for (var i in contentData.content) {
                    if (contentData.content[i].id === clickedEditID)
                    {
                        queryValue=contentData.content[i].title;
                        $("#viewContentModal-title").empty();
                        $('#viewContentModal-title').append(queryValue);

                        queryValue="<p>"+contentData.content[i].excerpt+"</p>";
                        $("#viewContentModal-excerpt").empty();
                        $('#viewContentModal-excerpt').append(queryValue);

                        queryValue=contentData.content[i].content_type;
                        $("#viewContentModal-categories").empty();
                        $('#viewContentModal-categories').append(queryValue);

                        queryValue=contentData.content[i].article_text;
                        $("#viewContentModal-content").empty();
                        $('#viewContentModal-content').append(queryValue);


                        queryValue=contentData.content[i].author;
                        $("#viewContentModal-Author").empty();
                        $('#viewContentModal-Author').append(queryValue);

                        queryValue=contentData.content[i].Published;
                        $("#viewContentModal-Date").empty();
                        $('#viewContentModal-Date').append(queryValue);

                        //send the correspondent image to the placeholder, but clean its containing div first
                        $("#viewContentModal-image").empty(); //clean the image Placeholder in the form
                        queryValue = "<img src='../assets/"+contentData.content[i].image+"' style='width:auto;height:auto;max-width:350;max-height:450px;margin-left:auto;margin-right:auto;'>";
                        $("#viewContentModal-image").append(queryValue);
                    } //ends If
                }//ends for loop
            }) //ends getJson
            $('#viewContentModal').foundation('reveal', 'open');
        }//Ends Function ViewContent




    });
</script>
</body>
</html>
